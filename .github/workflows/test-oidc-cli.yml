name: Test OIDC Connection (CLI)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - production

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
  test-oidc-cli:
    name: Test OIDC Connection (CLI)
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check AWS CLI
      run: |
        echo "🔍 Checking AWS CLI version..."
        aws --version
        
    - name: Configure AWS credentials (OIDC via CLI)
      run: |
        echo "🔍 Configuring AWS credentials via OIDC..."
        
        # Get the OIDC token
        TOKEN=$(curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com" | jq -r .value)
        
        # Assume the role
        CREDS=$(aws sts assume-role-with-web-identity \
          --role-arn arn:aws:iam::${{ vars.AWS_ACCOUNT_ID_DEV }}:role/GitHubActions-SoundBite-Dev \
          --web-identity-token $TOKEN \
          --role-session-name github-actions-test \
          --region ${{ env.AWS_REGION }} \
          --output json)
        
        # Extract credentials
        ACCESS_KEY=$(echo $CREDS | jq -r '.Credentials.AccessKeyId')
        SECRET_KEY=$(echo $CREDS | jq -r '.Credentials.SecretAccessKey')
        SESSION_TOKEN=$(echo $CREDS | jq -r '.Credentials.SessionToken')
        
        # Set environment variables
        echo "AWS_ACCESS_KEY_ID=$ACCESS_KEY" >> $GITHUB_ENV
        echo "AWS_SECRET_ACCESS_KEY=$SECRET_KEY" >> $GITHUB_ENV
        echo "AWS_SESSION_TOKEN=$SESSION_TOKEN" >> $GITHUB_ENV
        echo "AWS_DEFAULT_REGION=${{ env.AWS_REGION }}" >> $GITHUB_ENV
        
        echo "✅ AWS credentials configured successfully!"
        
    - name: Test AWS connection
      run: |
        echo "🔍 Testing AWS connection..."
        aws sts get-caller-identity
        echo "✅ AWS connection successful!"
        
    - name: Test AWS services access
      run: |
        echo "🔍 Testing AWS services access..."
        aws s3 ls || echo "S3 access test completed"
        aws dynamodb list-tables || echo "DynamoDB access test completed"
        aws sqs list-queues || echo "SQS access test completed"
        echo "✅ AWS services access test completed!"
